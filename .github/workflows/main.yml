name: GÃ¼nlÃ¼k Fon TaramasÄ± ve Kontrol

on:
  schedule:
    # TÃ¼rkiye saati ile 10:45 (UTC 07:45) - Ä°ÅŸ gÃ¼nleri (Pazartesi-Cuma)
    # Bursa, TÃ¼rkiye UTC+3 olduÄŸundan, 10:45 TRT iÃ§in 07:45 UTC'dir.
    - cron: '45 7 * * 1-5' # cron formatÄ± "dakika saat gÃ¼n_ay gÃ¼n_hafta"

  # Manuel olarak Ã§alÄ±ÅŸtÄ±rma yeteneÄŸi saÄŸlar
  workflow_dispatch:

jobs:
  tarama_isi:
    runs-on: ubuntu-latest

    steps:
    - name: Kodu Ã‡ek
      uses: actions/checkout@v4

    - name: Python OrtamÄ±nÄ± Kur
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        python -m pip install --upgrade pip
        # Standart Python baÄŸÄ±mlÄ±lÄ±k dosyasÄ±: requirements.txt
        if [ -f requirements.txt ]; then # Dosya adÄ±nÄ± 'requirements.txt' olarak dÃ¼zelttik
          pip install -r requirements.txt
        else
          echo "âŒ Hata: requirements.txt bulunamadÄ±! LÃ¼tfen dosya adÄ±nÄ± kontrol edin."
          exit 1
        fi

    - name: Ä°lk Tarama Scriptini Ã‡alÄ±ÅŸtÄ±r
      id: primary_scan_run
      env:
        GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      run: python tarama_script.py

    - name: BoÅŸ Veri KontrolÃ¼ ve Yeniden Ã‡alÄ±ÅŸtÄ±rma (Gerekliyse)
      if: steps.primary_scan_run.outputs.needs_retry == 'true'
      run: |
        echo "â— 5 veya daha fazla boÅŸ fiyat verisi tespit edildi. 20 dakika bekleyip tekrar denenecek."
        sleep 1200 # 20 dakika * 60 saniye = 1200 saniye
        echo "ğŸ”„ Yeniden tarama baÅŸlatÄ±lÄ±yor..."
        python tarama_script.py
